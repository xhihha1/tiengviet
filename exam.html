<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ğŸ“± iOS å…¨è¢å¹•æ”¯æ´ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="è¶Šå—èªå­¸ç¿’">

  <!-- âœ… Android Chrome å…¨è¢å¹•æ”¯æ´ -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#ffffff">

  <!-- Optional: å¯ä»¥åŠ å…¥è‡ªè¨‚ icon -->
  <link rel="apple-touch-icon" href="icon-512.png">
  <!-- favicon fallback -->
  <link rel="icon" type="image/png" href="icon-512.png">
  <title>Language Selection</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="common.css">
  <link rel="stylesheet" href="style-exam.css">
  
  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">
  <style>
    
  </style>
</head>

<body>
  <div class="header">
    <h1>è¶Šå—èªå–®å­—ç·´ç¿’</h1>
    <button id="langToggle" class="lang-toggle">
      <i class="fa-solid fa-language"></i>
    </button>
  </div>

  <div class="word-container">
    <div class="vn-word">
      <span id="current-word"></span>
      <button class="voice-btn" id="voice-btn">
        <i class="fas fa-volume-high"></i>
      </button>
    </div>

    <div class="options-container" id="options-container">
      <!-- é¸é …å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
    </div>

    <div class="feedback" id="feedback"></div>

    <button class="next-btn" id="next-btn" style="display: none;">Next</button>

    <div class="example-sentence" id="example-sentence" style="display: none;">
      <div class="sentence-vn" id="sentence-vn"></div>
      <div class="sentence-translation" id="sentence-translation"></div>
    </div>
  </div>

  <script>
    const voices = speechSynthesis.getVoices();
    const viVoice = voices.find(v => v.lang === 'vi-VN');
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    // ç¤ºä¾‹æ•¸æ“š - å¯¦éš›ä½¿ç”¨æ™‚æ‡‰è©²å¾lang.jsonåŠ è¼‰
    let wordList = [];

    // å¯¦éš›æ‡‰ç”¨ä¸­æ‡‰è©²ä½¿ç”¨fetchåŠ è¼‰JSONæ–‡ä»¶

    fetch('lang.json')
      .then(response => response.json())
      .then(data => {
        wordList = data;
        initApp();
      })
      .catch(error => console.error('Error loading word list:', error));


    let currentWord = null;
    let correctAnswer = null;
    let selectedOption = null;
    let options = [];
    let isAnswered = false;
    let isReversed = false;  // æ§åˆ¶æ¸¬é©—æ¨¡å¼

    // åˆå§‹åŒ–æ‡‰ç”¨
    function initApp() {
      if (wordList.length < 4) {
        console.error('éœ€è¦è‡³å°‘3å€‹å–®å­—æ‰èƒ½é€²è¡Œç·´ç¿’');
        return;
      }

      nextWord();

      // èªéŸ³æŒ‰éˆ•äº‹ä»¶
      document.getElementById('voice-btn').addEventListener('click', speakWord);

      // NextæŒ‰éˆ•äº‹ä»¶
      document.getElementById('next-btn').addEventListener('click', nextWord);

      // æ·»åŠ èªè¨€åˆ‡æ›äº‹ä»¶
      document.getElementById('langToggle').addEventListener('click', () => {
        isReversed = !isReversed;
        nextWord();
      });
    }

    // ç²å–ä¸‹ä¸€å€‹å–®å­—
    function nextWord() {
      // é‡ç½®ç‹€æ…‹
      document.getElementById('feedback').textContent = '';
      document.getElementById('next-btn').style.display = 'none';
      document.getElementById('example-sentence').style.display = 'none';
      selectedOption = null;
      isAnswered = false;

      // éš¨æ©Ÿé¸æ“‡ç•¶å‰å–®å­—
      const randomIndex = Math.floor(Math.random() * wordList.length);
      currentWord = wordList[randomIndex];

      // é¡¯ç¤ºç•¶å‰å–®å­—
      document.getElementById('current-word').textContent = 
        isReversed ? currentWord.zh : currentWord.vn;

      // ç”Ÿæˆé¸é …
      generateOptions(currentWord);
    }

    // ç”Ÿæˆé¸é …
    function generateOptions(correctWord) {
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.innerHTML = '';

      // æ”¶é›†æ‰€æœ‰å¯èƒ½çš„é¸é …ï¼ˆé™¤äº†æ­£ç¢ºç­”æ¡ˆï¼‰
      const otherWords = wordList.filter(word => word.vn !== correctWord.vn);

      // éš¨æ©Ÿé¸æ“‡2å€‹éŒ¯èª¤é¸é …
      const wrongOptions = [];
      while (wrongOptions.length < 3 && otherWords.length > 0) {
        const randomIndex = Math.floor(Math.random() * otherWords.length);
        wrongOptions.push(otherWords[randomIndex]);
        otherWords.splice(randomIndex, 1);
      }

      // å‰µå»ºé¸é …æ•¸çµ„ï¼ˆ1æ­£ç¢º + 2éŒ¯èª¤ï¼‰
      options = [correctWord, ...wrongOptions];

      // æ‰“äº‚é¸é …é †åº
      options.sort(() => Math.random() - 0.5);

      // è¨˜éŒ„æ­£ç¢ºç­”æ¡ˆçš„ç´¢å¼•
      correctAnswer = options.findIndex(option => option.vn === correctWord.vn);

      // ç”Ÿæˆé¸é …æŒ‰éˆ•
      options.forEach((option, index) => {
        const button = document.createElement('button');
        button.className = 'option-btn';
        // æ ¹æ“šæ¨¡å¼é¡¯ç¤ºä¸åŒçš„å…§å®¹
        button.innerHTML = isReversed 
          ? `<div class="vn-text">${option.vn}</div>`
          : `<div class="zh-text">${option.zh}</div>
             <div class="en-text">${option.en}</div>`;

        button.addEventListener('click', () => selectOption(index));
        optionsContainer.appendChild(button);
      });
    }

    // é¸æ“‡é¸é …
    function selectOption(index) {
      if (isAnswered) return; // é˜²æ­¢å·²å›ç­”å¾Œå†æ¬¡é¸æ“‡

      isAnswered = true;
      selectedOption = index;
      const buttons = document.querySelectorAll('.option-btn');
      const feedback = document.getElementById('feedback');

      if (index === correctAnswer) {
        playCorrect();
        // æ­£ç¢ºç­”æ¡ˆ
        buttons[index].classList.add('correct');
        feedback.textContent = 'æ­£ç¢º!';
        feedback.style.color = '#2ecc71';

        // é¡¯ç¤ºä¾‹å¥
        document.getElementById('sentence-vn').textContent = currentWord.sentence;
        document.getElementById('sentence-translation').textContent = currentWord.translation;
        document.getElementById('example-sentence').style.display = 'block';

        // é¡¯ç¤ºNextæŒ‰éˆ•
        document.getElementById('next-btn').style.display = 'block';
      } else {
        playWrong();
        // éŒ¯èª¤ç­”æ¡ˆ
        buttons[index].classList.add('incorrect');
        buttons[correctAnswer].classList.add('correct');
        feedback.textContent = 'ä¸æ­£ç¢ºï¼Œè«‹å†è©¦ä¸€æ¬¡';
        feedback.style.color = '#e74c3c';
        feedback.classList.add('try-again');

        // é¡¯ç¤ºNextæŒ‰éˆ•ï¼ˆå³ä½¿ç­”éŒ¯ä¹Ÿå…è¨±ç¹¼çºŒï¼‰
        document.getElementById('next-btn').style.display = 'block';
      }
    }

    // èªéŸ³æœ—è®€
    function speakWord() {
      if (!currentWord) return;

      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(currentWord.vn);
        utterance.lang = 'vi-VN'; // è¨­ç½®ç‚ºè¶Šå—èª
        if (viVoice) utterance.voice = viVoice;
        speechSynthesis.speak(utterance);
      } else {
        alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒèªéŸ³åˆæˆåŠŸèƒ½');
      }
    }

    

    function playTone(frequency, duration, type = 'sine') {
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();

      oscillator.type = type;
      oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);

      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);

      oscillator.start();

      // éŸ³é‡æ·¡å‡º
      gainNode.gain.setValueAtTime(1, audioCtx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);

      oscillator.stop(audioCtx.currentTime + duration);
    }

    function playCorrect() {
      // ç”¢ç”Ÿä¸€å€‹ã€Œå‡é«˜ã€çš„éŸ³éš
      playTone(440, 0.15);  // A4
      setTimeout(() => playTone(660, 0.15), 150);  // E5
    }

    function playWrong() {
      // ç”¢ç”Ÿä¸€å€‹ã€Œä¸‹é™ã€çš„éŒ¯èª¤éŸ³éš
      playTone(660, 0.15, 'square');  // E5
      setTimeout(() => playTone(440, 0.15, 'square'), 150);  // A4
    }


    // åˆå§‹åŒ–æ‡‰ç”¨
    // document.addEventListener('DOMContentLoaded', initApp);
  </script>
  <!-- æ·»åŠ åº•éƒ¨å°èˆªæ¬„ -->
  <nav class="bottom-nav">
    <a href="index.html" class="nav-item">
      <i class="fa-solid fa-list"></i>
      <span>List</span>
    </a>
    <a href="exam.html" class="nav-item active">
      <i class="fa-solid fa-graduation-cap"></i>
      <span>Exam</span>
    </a>
  </nav>
</body>

</html>